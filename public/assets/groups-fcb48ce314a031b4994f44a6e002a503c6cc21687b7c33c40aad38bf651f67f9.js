/*
 * jQuery Plugin: Tokenizing Autocomplete Text Entry
 * Version 1.6.0
 *
 * Copyright (c) 2009 James Smith (http://loopj.com)
 * Licensed jointly under the GPL and MIT licenses,
 * choose which one suits your project best!
 *
 */
!function(e){var t={method:"GET",contentType:"json",queryParam:"q",searchDelay:300,minChars:1,propertyToSearch:"name",jsonContainer:null,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",animateDropdown:!0,tokenLimit:null,tokenDelimiter:",",preventDuplicates:!1,tokenValue:"id",prePopulate:null,processPrePopulate:!1,idPrefix:"token-input-",resultsFormatter:function(e){return"<li>"+e[this.propertyToSearch]+"</li>"},tokenFormatter:function(e){return"<li><p>"+e[this.propertyToSearch]+"</p></li>"},onResult:null,onAdd:null,onDelete:null,onReady:null},n={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},r={BEFORE:0,AFTER:1,END:2},o={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188},i={init:function(n,r){var o=e.extend({},t,r||{});return this.each(function(){e(this).data("tokenInputObject",new e.TokenList(this,n,o))})},clear:function(){return this.data("tokenInputObject").clear(),this},add:function(e){return this.data("tokenInputObject").add(e),this},remove:function(e){return this.data("tokenInputObject").remove(e),this},get:function(){return this.data("tokenInputObject").getTokens()}};e.fn.tokenInput=function(e){return i[e]?i[e].apply(this,Array.prototype.slice.call(arguments,1)):i.init.apply(this,arguments)},e.TokenList=function(t,i,a){function s(){return null!==a.tokenLimit&&D>=a.tokenLimit?(q.hide(),void g()):void 0}function c(){if(x!==(x=q.val())){var e=x.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");B.html(e),q.width(B.width()+30)}}function u(t){var n=a.tokenFormatter(t);n=e(n).addClass(a.classes.token).insertBefore(U),e("<span>"+a.deleteText+"</span>").addClass(a.classes.tokenDelete).appendTo(n).click(function(){return h(e(this).parent()),P.change(),!1});var r={id:t.id};return r[a.propertyToSearch]=t[a.propertyToSearch],e.data(n.get(0),"tokeninput",t),I=I.slice(0,L).concat([r]).concat(I.slice(L)),L++,m(I,P),D+=1,null!==a.tokenLimit&&D>=a.tokenLimit&&(q.hide(),g()),n}function l(t){var n=a.onAdd;if(D>0&&a.preventDuplicates){var r=null;if(M.children().each(function(){var n=e(this),o=e.data(n.get(0),"tokeninput");return o&&o.id===t.id?(r=n,!1):void 0}),r)return p(r),U.insertAfter(r),void q.focus()}(null==a.tokenLimit||D<a.tokenLimit)&&(u(t),s()),q.val(""),g(),e.isFunction(n)&&n.call(P,t)}function p(e){e.addClass(a.classes.selectedToken),O=e.get(0),q.val(""),g()}function d(e,t){e.removeClass(a.classes.selectedToken),O=null,t===r.BEFORE?(U.insertBefore(e),L--):t===r.AFTER?(U.insertAfter(e),L++):(U.appendTo(M),L=D),q.focus()}function f(t){var n=O;O&&d(e(O),r.END),n===t.get(0)?d(t,r.END):p(t)}function h(t){var n=e.data(t.get(0),"tokeninput"),r=a.onDelete,o=t.prevAll().length;o>L&&o--,t.remove(),O=null,q.focus(),I=I.slice(0,o).concat(I.slice(o+1)),L>o&&L--,m(I,P),D-=1,null!==a.tokenLimit&&q.show().val("").focus(),e.isFunction(r)&&r.call(P,n)}function m(t,n){var r=e.map(t,function(e){return e[a.tokenValue]});n.val(r.join(a.tokenDelimiter))}function g(){H.hide().empty(),F=null}function v(){H.css({position:"absolute",top:e(M).offset().top+e(M).outerHeight(),left:e(M).offset().left,zindex:999}).show()}function y(){a.searchingText&&(H.html("<p>"+a.searchingText+"</p>"),v())}function _(){a.hintText&&(H.html("<p>"+a.hintText+"</p>"),v())}function w(e,t){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")}function k(e,t,n){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","g"),w(t,n))}function S(t,n){if(n&&n.length){H.empty();var r=e("<ul>").appendTo(H).mouseover(function(t){T(e(t.target).closest("li"))}).mousedown(function(t){return l(e(t.target).closest("li").data("tokeninput")),P.change(),!1}).hide();e.each(n,function(n,o){var i=a.resultsFormatter(o);i=k(i,o[a.propertyToSearch],t),i=e(i).appendTo(r),n%2?i.addClass(a.classes.dropdownItem):i.addClass(a.classes.dropdownItem2),0===n&&T(i),e.data(i.get(0),"tokeninput",o)}),v(),a.animateDropdown?r.slideDown("fast"):r.show()}else a.noResultsText&&(H.html("<p>"+a.noResultsText+"</p>"),v())}function T(t){t&&(F&&b(e(F)),t.addClass(a.classes.selectedDropdownItem),F=t.get(0))}function b(e){e.removeClass(a.classes.selectedDropdownItem),F=null}function C(){var t=q.val().toLowerCase();t&&t.length&&(O&&d(e(O),r.AFTER),t.length>=a.minChars?(y(),clearTimeout(R),R=setTimeout(function(){E(t)},a.searchDelay)):g())}function E(t){var n=t+A(),r=N.get(n);if(r)S(t,r);else if(a.url){var o=A(),i={};if(i.data={},o.indexOf("?")>-1){var s=o.split("?");i.url=s[0];var c=s[1].split("&");e.each(c,function(e,t){var n=t.split("=");i.data[n[0]]=n[1]})}else i.url=o;i.data[a.queryParam]=t,i.type=a.method,i.dataType=a.contentType,a.crossDomain&&(i.dataType="jsonp"),i.success=function(r){e.isFunction(a.onResult)&&(r=a.onResult.call(P,r)),N.add(n,a.jsonContainer?r[a.jsonContainer]:r),q.val().toLowerCase()===t&&S(t,a.jsonContainer?r[a.jsonContainer]:r)},e.ajax(i)}else if(a.local_data){var u=e.grep(a.local_data,function(e){return e[a.propertyToSearch].toLowerCase().indexOf(t.toLowerCase())>-1});e.isFunction(a.onResult)&&(u=a.onResult.call(P,u)),N.add(n,u),S(t,u)}}function A(){var e=a.url;return"function"==typeof a.url&&(e=a.url.call()),e}if("string"===e.type(i)||"function"===e.type(i)){a.url=i;var j=A();void 0===a.crossDomain&&(-1===j.indexOf("://")?a.crossDomain=!1:a.crossDomain=location.href.split(/\/+/g)[1]!==j.split(/\/+/g)[1])}else"object"==typeof i&&(a.local_data=i);a.classes?a.classes=e.extend({},n,a.classes):a.theme?(a.classes={},e.each(n,function(e,t){a.classes[e]=t+"-"+a.theme})):a.classes=n;var R,x,I=[],D=0,N=new e.TokenList.Cache,q=e('<input type="text"  autocomplete="off">').css({outline:"none"}).attr("id",a.idPrefix+t.id).focus(function(){(null===a.tokenLimit||a.tokenLimit!==D)&&_()}).blur(function(){g(),e(this).val("")}).bind("keyup keydown blur update",c).keydown(function(t){var n,i;switch(t.keyCode){case o.LEFT:case o.RIGHT:case o.UP:case o.DOWN:if(e(this).val()){var a=null;return a=t.keyCode===o.DOWN||t.keyCode===o.RIGHT?e(F).next():e(F).prev(),a.length&&T(a),!1}n=U.prev(),i=U.next(),n.length&&n.get(0)===O||i.length&&i.get(0)===O?t.keyCode===o.LEFT||t.keyCode===o.UP?d(e(O),r.BEFORE):d(e(O),r.AFTER):t.keyCode!==o.LEFT&&t.keyCode!==o.UP||!n.length?t.keyCode!==o.RIGHT&&t.keyCode!==o.DOWN||!i.length||p(e(i.get(0))):p(e(n.get(0)));break;case o.BACKSPACE:if(n=U.prev(),!e(this).val().length)return O?(h(e(O)),P.change()):n.length&&p(e(n.get(0))),!1;1===e(this).val().length?g():setTimeout(function(){C()},5);break;case o.TAB:case o.ENTER:case o.NUMPAD_ENTER:case o.COMMA:if(F)return l(e(F).data("tokeninput")),P.change(),!1;break;case o.ESCAPE:return g(),!0;default:String.fromCharCode(t.which)&&setTimeout(function(){C()},5)}}),P=e(t).hide().val("").focus(function(){q.focus()}).blur(function(){q.blur()}),O=null,L=0,F=null,M=e("<ul />").addClass(a.classes.tokenList).click(function(t){var n=e(t.target).closest("li");n&&n.get(0)&&e.data(n.get(0),"tokeninput")?f(n):(O&&d(e(O),r.END),q.focus())}).mouseover(function(t){var n=e(t.target).closest("li");n&&O!==this&&n.addClass(a.classes.highlightedToken)}).mouseout(function(t){var n=e(t.target).closest("li");n&&O!==this&&n.removeClass(a.classes.highlightedToken)}).insertBefore(P),U=e("<li />").addClass(a.classes.inputToken).appendTo(M).append(q),H=e("<div>").addClass(a.classes.dropdown).appendTo("body").hide(),B=e("<tester/>").insertAfter(q).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:q.css("fontSize"),fontFamily:q.css("fontFamily"),fontWeight:q.css("fontWeight"),letterSpacing:q.css("letterSpacing"),whiteSpace:"nowrap"});P.val("");var $=a.prePopulate||P.data("pre");a.processPrePopulate&&e.isFunction(a.onResult)&&($=a.onResult.call(P,$)),$&&$.length&&e.each($,function(e,t){u(t),s()}),e.isFunction(a.onReady)&&a.onReady.call(),this.clear=function(){M.children("li").each(function(){0===e(this).children("input").length&&h(e(this))})},this.add=function(e){l(e)},this.remove=function(t){M.children("li").each(function(){if(0===e(this).children("input").length){var n=e(this).data("tokeninput"),r=!0;for(var o in t)if(t[o]!==n[o]){r=!1;break}r&&h(e(this))}})},this.getTokens=function(){return I}},e.TokenList.Cache=function(t){var n=e.extend({max_size:500},t),r={},o=0,i=function(){r={},o=0};this.add=function(e,t){o>n.max_size&&i(),r[e]||(o+=1),r[e]=t},this.get=function(e){return r[e]}}}(jQuery),function(){var e;e=function(){$("#invitationForm").validate({ignore:".ignore",rules:{autocomplete:"required"},messages:{autocomplete:"Please enter your email invitation"}})},$(document).ready(function(){return e(),$("#invite_user_id").tokenInput("/group/users_collection.json",{allowCustomEntry:!0,preventDuplicates:!1,prePopulate:$("#invite_user_id").data("load")}),$("#slideToggleLink").click(function(){return $("#slideToggle").slideToggle()})})}.call(this);